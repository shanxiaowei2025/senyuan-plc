# PLC控制规则文档

## 📋 概述

本文档详细描述了森源管理系统中PLC控制的三条核心业务规则。这些规则实现了步料台控制、北向伺服定位和数据采集入库的自动化流程。

## 🔧 规则实现位置

- **文件路径**: `src/lib/plc-monitor-service.ts`
- **监控服务**: 系统启动后自动运行，持续监控PLC状态变化
- **触发机制**: 基于上升沿检测，确保规则只在状态变化时执行一次

## 🔒 写寄存器验证机制

**重要安全特性**：所有规则中的写寄存器操作都实现了验证机制：

- ✅ **写入后验证**：每次写入寄存器后，等待0.5秒，然后读取验证
- ✅ **值匹配检查**：确认写入值与读取值一致（浮点数允许0.0001误差）
- ✅ **失败终止**：如果验证失败，立即终止当前规则的后续操作
- ⚠️ **线圈操作免验证**：写线圈操作不进行验证（按用户要求）

**验证范围**：
- 规则1：D2000（测量位置）写入验证
- 规则2：D2004（钢筋长度）写入验证
- 规则3：无写寄存器操作（仅读取寄存器和数据库操作）

---

## 📖 规则详细说明

### 规则1：步料台大臂伸出至测量位

#### 🎯 规则描述
当步料台大臂伸出至测量位时，系统自动计算最佳的钢筋测量位置。

#### ⚡ 触发条件
- **触发信号**: M4000 为 ON（检测上升沿）
- **检测方式**: 从OFF变为ON的上升沿触发

#### 🔄 执行流程

1. **读取钢筋参数**
   - 读取 `D2012`（钢筋圈半径）
   - 读取 `D2016`（钢筋直径）
   - 计算目标值：钢筋圈半径 + 钢筋直径

2. **查找最佳测量位置**
   - 从预配置的8个钢筋测量位置中筛选
   - 查找比目标值大且差值最小的位置
   - 如果没有找到比目标值大的位置，使用最大的测量位置

3. **写入测量位置**
   - 将选定的测量位置值写入 `D2000`
   - 记录执行日志

4. **复位触发信号**
   - 将 `M4000` 复位为 OFF

#### 📊 相关寄存器
| 寄存器 | 类型 | 说明 |
|--------|------|------|
| M4000 | 线圈 | 触发信号（输入） |
| D2012 | Float32 | 钢筋圈半径（输入） |
| D2016 | Float32 | 钢筋直径（输入） |
| D2000 | Float32 | 钢筋测量位置（输出） |

#### 💾 配置数据
钢筋测量位置配置存储在 `data/measure-positions.json` 文件中，包含8个预设位置。

---

### 规则2：M4001北向伺服定位位置

#### 🎯 规则描述
当M4001为ON时，根据M4003和M4004的状态执行不同的定位逻辑，计算并写入钢筋长度到D2004寄存器。

#### ⚡ 触发条件
- **主触发**: M4001 状态变化为 ON
- **分支选择**: M4003 或 M4004 为 ON 状态

#### 🔄 执行流程

##### M4003为ON时的逻辑：
1. **读取基础数据**
   - 读取 `D2020`（北定位基础值第一套）
   - 读取 `D2044`（笼子节数）

2. **判断处理方式**
   - **当笼子节数 = 1时**：直接将D2020的值写入D2004
   - **当笼子节数 > 1时**：进行复杂计算流程

3. **复杂计算流程**（笼子节数 > 1）
   - 读取 `D4012`（主轴角度）
   - 读取 `D2040`（型号）
   - 读取 `D2048`（笼子编号）
   - 计算查询节数：当前笼子节数 - 1
   - 查询数据库中匹配条件的记录：型号、笼子节数（当前节数-1）、角度、笼子编号
   - 获取查询到记录的差值字段的值
   - 计算最终结果：D2020 - 差值，写入D2004
   - **容错处理**：如果未找到匹配记录或差值为空，直接使用D2020值

##### M4004为ON时的逻辑：
1. **读取基础数据**
   - 读取 `D2024`（北定位基础值第二套）
   - 读取 `D2044`（笼子节数）

2. **判断处理方式**
   - **当笼子节数 = 1时**：直接将D2024的值写入D2004
   - **当笼子节数 > 1时**：进行复杂计算流程

3. **复杂计算流程**（笼子节数 > 1）
   - 读取 `D4012`（主轴角度）
   - 读取 `D2040`（型号）
   - 读取 `D2048`（笼子编号）
   - 计算查询节数：当前笼子节数 - 1
   - 查询数据库中匹配条件的记录：型号、笼子节数（当前节数-1）、角度、笼子编号
   - 获取查询到记录的差值字段的值
   - 计算最终结果：D2024 - 差值，写入D2004
   - **容错处理**：如果未找到匹配记录或差值为空，直接使用D2024值

4. **复位触发信号**
   - 执行完成后将 `M4001` 复位为 OFF

#### 🔄 执行机制
- **状态检测**: 检测M4001状态变化（从OFF到ON或从ON到OFF）
- **分支选择**: M4001为ON时，检测M4003和M4004状态决定执行分支
- **优先级**: 如果M4003和M4004都为ON，优先执行M4003分支
- **防重复**: 使用lastExecutedBranch跟踪已执行分支，避免重复执行
- **自动复位**: 执行完成后自动将M4001复位为OFF
- **错误处理**: 写入验证失败时终止规则执行并记录错误日志

#### 📊 相关寄存器
| 寄存器 | 类型 | 说明 |
|--------|------|------|
| M4001 | 线圈 | 主触发信号（输入） |
| M4003 | 线圈 | 第一套逻辑触发（输入） |
| M4004 | 线圈 | 第二套逻辑触发（输入） |
| D2020 | Float32 | 北定位基础值第一套（输入） |
| D2024 | Float32 | 北定位基础值第二套（输入） |
| D2044 | Float32 | 笼子节数（输入） |
| D4012 | Float32 | 主轴角度（输入） |
| D2040 | Float32 | 型号（输入） |
| D2048 | Float32 | 笼子编号（输入） |

| D2004 | Float32 | 计算结果输出 |

---

### 规则3：M4002数据采集和数据库写入

#### 🎯 规则描述
当M4002上升沿触发时，根据M4003和M4004的状态选择不同的理论长度寄存器，读取多个寄存器的值，计算钢筋实际长度和差值，查询数据库中是否存在重复记录，如果重复则更新记录，否则创建新记录。当笼子节数等于总节数时，实际长度和差值存储为null。

#### ⚡ 触发条件
- **触发信号**: M4002 为 ON（检测上升沿）
- **检测方式**: 从OFF变为ON的上升沿触发

#### 🔄 执行流程

1. **上升沿检测**
   - 检测M4002从OFF变为ON的上升沿
   - 只有在上升沿时才执行规则，避免重复执行

2. **状态检测**
   - 读取 `M4003` 和 `M4004` 状态
   - 根据状态确定执行分支：
     - M4003为ON：执行M4003分支逻辑
     - M4004为ON：执行M4004分支逻辑
     - 都为OFF：跳过数据采集并记录警告

3. **M4003分支逻辑**（当M4003为ON时）
   - **读取寄存器数据**（并行读取8个寄存器）：
     - 读取 `D2028`（理论长度 - M4003专用）
     - 读取 `D2040`（型号）
     - 读取 `D2044`（笼子节数）
     - 读取 `D2048`（笼子编号）
     - 读取 `D4012`（主轴角度）
     - 读取 `D4028`（北伺服位置）
     - 读取 `D4044`（南伺服位置）
     - 读取 `D2052`（总节数）
   
   - **计算钢筋实际长度**：
     - 钢筋实际长度 = D4044（南伺服位置） - D4028（北伺服位置）
   
   - **计算差值**：
     - 差值 = D2028（理论长度） - 钢筋实际长度

4. **M4004分支逻辑**（当M4004为ON时）
   - **读取寄存器数据**（并行读取8个寄存器）：
     - 读取 `D2032`（理论长度 - M4004专用）
     - 读取 `D2040`（型号）
     - 读取 `D2044`（笼子节数）
     - 读取 `D2048`（笼子编号）
     - 读取 `D4012`（主轴角度）
     - 读取 `D4028`（北伺服位置）
     - 读取 `D4044`（南伺服位置）
     - 读取 `D2052`（总节数）
   
   - **计算钢筋实际长度**：
     - 钢筋实际长度 = D4044（南伺服位置） - D4028（北伺服位置）
   
   - **计算差值**：
     - 差值 = D2032（理论长度） - 钢筋实际长度

5. **特殊存储逻辑**
   - **当笼子节数D2044 = 总节数D2052时**：
     - 实际长度存储为 `null`
     - 差值存储为 `null`
   - **其他情况**：正常存储计算值

6. **数据库操作**
   - **重复记录判断**：根据型号（D2040）、笼子节数（D2044）、笼子编号（D2048）、主轴角度（D4012）四个字段查询
   - **数据库处理**：
     - 如果存在重复记录：更新现有记录的所有字段
     - 如果不存在重复记录：创建新的数据记录
   - **时间戳**：自动记录创建时间和更新时间

7. **复位触发信号**
   - 将 `M4002` 复位为 OFF
   - 记录规则执行完成日志

#### 📊 相关寄存器
| 寄存器 | 类型 | 说明 |
|--------|------|------|
| M4002 | 线圈 | 触发信号（输入） |
| M4003 | 线圈 | 第一套逻辑标识（输入） |
| M4004 | 线圈 | 第二套逻辑标识（输入） |
| D2028 | Float32 | 理论长度 - M4003分支（输入） |
| D2032 | Float32 | 理论长度 - M4004分支（输入） |
| D2040 | Float32 | 型号（输入） |
| D2044 | Float32 | 笼子节数（输入） |
| D2048 | Float32 | 笼子编号（输入） |
| D4012 | Float32 | 主轴角度（输入） |
| D4028 | Float32 | 北伺服位置（输入） |
| D4044 | Float32 | 南伺服位置（输入） |
| D2052 | Float32 | 总节数（输入） |

#### 🗃️ 数据库表结构
规则3操作 `SyPlc` 表，表结构如下：
```sql
model SyPlc {
  id                String   @id @default(cuid())
  modelD2040        Float    // 型号 (D2040)
  cageNodesD2044    Float    // 笼子节数 (D2044)  
  cageNumD2048      Float    // 笼子编号 (D2048)
  spindleAngleD4012 Float    // 主轴角度 (D4012)
  actualRebarLength Float?   // 钢筋实际长度（可为null）
  theoreticalLength Float    // 理论长度（D2028或D2032）
  difference        Float?   // 差值（可为null）
  totalNodesD2052   Float    // 总节数 (D2052)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
```

#### 💡 特殊逻辑说明
- **上升沿检测**：使用状态跟踪机制，只在M4002从OFF变为ON时执行一次
- **分支选择**：根据M4003和M4004状态选择不同的理论长度寄存器
- **并行读取**：8个寄存器并行读取，提高执行效率
- **重复记录判断**：基于`modelD2040`、`cageNodesD2044`、`cageNumD2048`、`spindleAngleD4012`四个字段
- **null值存储**：当`cageNodesD2044 = totalNodesD2052`时，`actualRebarLength`和`difference`存储为null
- **理论长度来源**：M4003分支使用D2028，M4004分支使用D2032
- **容错处理**：M4003和M4004都为OFF时跳过数据采集并记录警告日志

---

## 🔍 监控和日志

### 执行状态监控
- 规则2的执行状态可通过 `/api/plc/rule2-status` 接口查询
- 实时显示M4001、M4003、M4004寄存器的当前状态
- 记录上次执行的分支和执行时间戳
- 所有规则执行过程都有详细的状态跟踪和日志记录

### 日志记录
- 所有规则执行过程都有详细的日志记录
- **规则1**：记录触发时间、钢筋参数、测量位置选择、写入验证结果
- **规则2**：记录分支选择、数据库查询、计算过程、写入验证结果
- **规则3**：记录寄存器读取、计算过程、数据库操作结果
- 错误情况会记录警告或错误级别的日志
- 日志可通过系统日志页面或设备管理页面查看

### 错误处理
- **PLC通信失败**：自动重试机制，连接断开时调整检查间隔
- **寄存器读取失败**：记录错误日志，跳过当前执行周期
- **写入验证失败**：立即终止当前规则执行，防止错误数据传递
- **数据库操作失败**：记录详细错误信息，不影响PLC操作
- **容错机制**：规则2中未找到数据库记录时使用默认值
- **隔离执行**：各规则独立执行，单个规则异常不影响其他规则

---

## ⚙️ 配置说明

### PLC连接配置
- **IP地址**: 192.168.55.199（默认）
- **端口**: 502（Modbus TCP标准端口）
- **设备ID**: 1
- **轮询间隔**: 1000ms（1秒）

### 钢筋测量位置配置
- **配置文件**: `data/measure-positions.json`
- **位置数量**: 8个
- **数据格式**: JSON数组，包含位置名称、数值、描述等信息
- **可通过设备管理页面进行在线配置**

---

## 🚀 启动和运行

### 自动启动
- 系统启动后，PLC监控服务自动运行
- 服务会自动尝试连接PLC设备
- 连接成功后开始监控规则触发条件

### 手动控制
- 可通过设备管理页面手动启动/停止监控服务
- 支持实时查看PLC连接状态和数据
- 提供测试连接功能

### 状态查看
- 实时显示PLC连接状态
- 显示各个规则的执行状态
- 显示最近的执行日志和错误信息

---

## 📝 注意事项

1. **上升沿检测**: 规则1和规则3基于上升沿触发，规则2基于状态变化触发
2. **数据类型**: 所有寄存器数据都使用32位浮点数格式
3. **写入验证**: 规则1和规则2的写寄存器操作都有验证机制，验证失败会终止执行
4. **状态跟踪**: 使用ruleStates对象跟踪各规则的执行状态，防止重复执行
5. **错误恢复**: 通信错误时系统会自动尝试重连，调整检查间隔
6. **并发安全**: 规则独立执行，互不影响
7. **性能优化**: 并行读取寄存器，轮询间隔根据连接状态自适应调整
8. **日志记录**: 所有操作都有详细的日志记录，便于调试和监控

---

## 🔧 维护和调试

### 调试模式
- 开发环境下会输出详细的控制台日志
- 生产环境下只记录关键信息和错误

### 常见问题
1. **PLC连接失败**: 检查网络连接和IP地址配置
2. **规则不触发**: 确认M寄存器状态变化和上升沿检测
3. **数据库写入失败**: 检查数据库连接和表结构
4. **计算结果异常**: 验证输入数据的有效性和计算逻辑

### 性能监控
- 监控PLC通信延迟
- 监控规则执行时间
- 监控数据库操作性能
- 监控内存和CPU使用情况

---

*文档版本: v1.0*  
*最后更新: 2024年7月*  
*维护者: 森源技术团队* 