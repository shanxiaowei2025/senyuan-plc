name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
    
    - name: èŽ·å–pnpm storeç›®å½•
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: ç¼“å­˜pnpmä¾èµ–
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: å®‰è£…ä¾èµ–
      run: pnpm install --no-frozen-lockfile
    
    - name: ç”ŸæˆPrismaå®¢æˆ·ç«¯
      run: pnpm run db:generate
    
    - name: æž„å»ºNext.jsåº”ç”¨
      run: pnpm run build
    
    - name: æ‰“åŒ…Windowså¯æ‰§è¡Œæ–‡ä»¶
      run: pnpm exec electron-builder --win --x64
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        dir dist-electron
    
    - name: ä¸Šä¼ NSISå®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: æ£®æºç®¡ç†ç³»ç»Ÿ-Windows-Installer
        path: dist-electron/*.exe
        if-no-files-found: error
    
    - name: ä¸Šä¼ blockmapæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: blockmap-files
        path: dist-electron/*.blockmap
        if-no-files-found: warn
    
    - name: æž„å»ºæˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶æž„å»ºæˆåŠŸï¼"
        echo "ðŸ“¦ è¯·åœ¨ Actions -> Artifacts ä¸­ä¸‹è½½"
