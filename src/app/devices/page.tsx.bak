"use client"

import { useState, useEffect } from "react"
import { MainLayout } from "@/components/layout/main-layout"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { 
  Plus, 
  Building, 
  Database, 
  FileText, 
  Settings, 
  Play, 
  Pause, 
  RefreshCw,
  Download,
  Upload,
  Monitor,
  HardDrive,
  Activity,
  Clock,
  AlertTriangle,
  CheckCircle,
  TrendingUp,
  TrendingDown,
  Wrench,
  Calendar,
  BarChart3,
  Filter,
  Search,
  Eye,
  Edit,
  Trash2,
  ToggleLeft,
  ToggleRight,
  Gauge,
  Server,
  Save
} from "lucide-react"

// 模拟焊笼机设备数据
const weldingMachineData = {
  id: "WM-001",
  name: "焊笼机-01",
  status: "运行中",
  location: "生产车间A区",
  lastMaintenance: "2024-01-10",
  nextMaintenance: "2024-02-10",
  uptime: "168小时",
  temperature: "45°C",
  pressure: "2.5MPa",
  current: "180A",
  voltage: "22V",
  efficiency: "95%",
  totalWorkpieces: 1250,
  todayWorkpieces: 45
}

// PLC日志接口
interface PLCLog {
  id: string
  timestamp: string
  level: 'INFO' | 'WARNING' | 'ERROR'
  message: string
  source: string
  details?: string
}

// PLC状态接口
interface PLCStatus {
  isConnected: boolean
  isConnecting: boolean
  reconnectAttempts: number
  maxReconnectAttempts: number
  config: {
    host: string
    port: number
    unitId: number
    timeout: number
    reconnectInterval: number
    maxReconnectAttempts: number
  }
}

// 模拟数据库记录
const databaseRecords = [
  {
    id: 1,
    timestamp: "2024-01-15 14:30:25",
    operation: "INSERT",
    table: "welding_records",
    record_id: "WR-2024-0015",
    description: "新增焊接记录"
  },
  {
    id: 2,
    timestamp: "2024-01-15 14:25:18",
    operation: "UPDATE",
    table: "device_status",
    record_id: "DS-001",
    description: "更新设备状态"
  },
  {
    id: 3,
    timestamp: "2024-01-15 14:20:45",
    operation: "INSERT",
    table: "quality_check",
    record_id: "QC-2024-0015",
    description: "质量检测记录"
  },
  {
    id: 4,
    timestamp: "2024-01-15 14:15:32",
    operation: "UPDATE",
    table: "system_logs",
    record_id: "SL-001",
    description: "系统日志更新"
  },
  {
    id: 5,
    timestamp: "2024-01-15 14:10:15",
    operation: "UPDATE",
    table: "welding_params",
    record_id: "WP-001",
    description: "焊接参数调整"
  }
]



export default function DevicesPage() {
  const [activeTab, setActiveTab] = useState<'logs' | 'database' | 'plcio' | 'config'>('logs')
  const [plcStatus, setPlcStatus] = useState<PLCStatus | null>(null)
  const [plcLogs, setPlcLogs] = useState<PLCLog[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  const [logFilter, setLogFilter] = useState('all')
  const [isLoading, setIsLoading] = useState(false)
  // 添加PLC读写相关状态
  const [floatRegisterAddress, setFloatRegisterAddress] = useState<number>(100)
  const [floatRegisterValue, setFloatRegisterValue] = useState<number | null>(null)
  const [floatInputValue, setFloatInputValue] = useState<string>('')
  const [coilAddress, setCoilAddress] = useState<number>(0)
  const [coilValue, setCoilValue] = useState<boolean | null>(null)
  const [isReadingFloat, setIsReadingFloat] = useState<boolean>(false)
  const [isWritingFloat, setIsWritingFloat] = useState<boolean>(false)
  const [isReadingCoil, setIsReadingCoil] = useState<boolean>(false)
  const [isWritingCoil, setIsWritingCoil] = useState<boolean>(false)
  const [plcError, setPlcError] = useState<string | null>(null)
  
  // 添加PLC配置相关状态
  const [plcConfig, setPlcConfig] = useState({
    host: '192.168.55.199',
    port: 502,
    unitId: 1,
    timeout: 5000,
    reconnectInterval: 3000,
    maxReconnectAttempts: 3
  })
  const [isUpdatingConfig, setIsUpdatingConfig] = useState(false)
  const [configSuccess, setConfigSuccess] = useState<string | null>(null)
  const [showConfigAlert, setShowConfigAlert] = useState<boolean>(false)

  const getLogLevelColor = (level: string) => {
    switch (level) {
      case 'ERROR': return 'text-red-600 bg-red-50 border-red-200'
      case 'WARNING': return 'text-yellow-600 bg-yellow-50 border-yellow-200'
      case 'INFO': return 'text-blue-600 bg-blue-50 border-blue-200'
      default: return 'text-gray-600 bg-gray-50 border-gray-200'
    }
  }

  const getOperationColor = (operation: string) => {
    switch (operation) {
      case 'INSERT': return 'text-green-600 bg-green-50 border-green-200'
      case 'UPDATE': return 'text-blue-600 bg-blue-50 border-blue-200'
      case 'DELETE': return 'text-red-600 bg-red-50 border-red-200'
      default: return 'text-gray-600 bg-gray-50 border-gray-200'
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case '运行中': return 'text-green-600 bg-green-50 border-green-200'
      case '已停止': return 'text-red-600 bg-red-50 border-red-200'
      case '维护中': return 'text-yellow-600 bg-yellow-50 border-yellow-200'
      default: return 'text-gray-600 bg-gray-50 border-gray-200'
    }
  }

  // 获取PLC状态
  const fetchPLCStatus = async () => {
    try {
      const response = await fetch('/api/plc/status')
      const result = await response.json()
      if (result.success) {
        setPlcStatus(result.data)
      }
    } catch (error) {
      console.error('获取PLC状态失败:', error)
    }
  }

  // 获取PLC日志
  const fetchPLCLogs = async () => {
    try {
      const response = await fetch('/api/plc/logs?limit=50')
      const result = await response.json()
      if (result.success) {
        const formattedLogs = result.data.map((log: any) => ({
          ...log,
          timestamp: new Date(log.timestamp).toLocaleString('zh-CN')
        }))
        setPlcLogs(formattedLogs)
      }
    } catch (error) {
      console.error('获取PLC日志失败:', error)
    }
  }

  // 连接PLC
  const connectPLC = async () => {
    setIsLoading(true)
    try {
      const response = await fetch('/api/plc/connect', {
        method: 'POST'
      })
      const result = await response.json()
      if (result.success) {
        setTimeout(() => {
          fetchPLCStatus()
          fetchPLCLogs()
        }, 1000)
      }
    } catch (error) {
      console.error('连接PLC失败:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // 断开PLC连接
  const disconnectPLC = async () => {
    setIsLoading(true)
    try {
      const response = await fetch('/api/plc/connect', {
        method: 'DELETE'
      })
      const result = await response.json()
      if (result.success) {
        setTimeout(() => {
          fetchPLCStatus()
          fetchPLCLogs()
        }, 1000)
      }
    } catch (error) {
      console.error('断开PLC连接失败:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // 刷新数据
  const refreshData = async () => {
    setIsLoading(true)
    try {
      await Promise.all([fetchPLCStatus(), fetchPLCLogs()])
    } finally {
      setIsLoading(false)
    }
  }

  // 读取32位浮点数寄存器
  const readFloatRegister = async () => {
    if (!plcStatus?.isConnected) {
      setPlcError('PLC未连接')
      return
    }
    
    setIsReadingFloat(true)
    setPlcError(null)
    
    try {
      const response = await fetch(`/api/plc/float32?address=${floatRegisterAddress}`)
      const result = await response.json()
      
      if (result.success) {
        setFloatRegisterValue(result.data.value)
      } else {
        setPlcError(result.error || '读取失败')
      }
    } catch (error) {
      console.error('读取浮点寄存器失败:', error)
      setPlcError('读取失败，请查看控制台')
    } finally {
      setIsReadingFloat(false)
    }
  }
  
  // 写入32位浮点数寄存器
  const writeFloatRegister = async () => {
    if (!plcStatus?.isConnected) {
      setPlcError('PLC未连接')
      return
    }
    
    const value = parseFloat(floatInputValue)
    if (isNaN(value)) {
      setPlcError('请输入有效的浮点数')
      return
    }
    
    setIsWritingFloat(true)
    setPlcError(null)
    
    try {
      const response = await fetch('/api/plc/float32', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          address: floatRegisterAddress,
          value: value
        })
      })
      
      const result = await response.json()
      
      if (result.success) {
        setFloatRegisterValue(value)
        setFloatInputValue('')
      } else {
        setPlcError(result.error || '写入失败')
      }
    } catch (error) {
      console.error('写入浮点寄存器失败:', error)
      setPlcError('写入失败，请查看控制台')
    } finally {
      setIsWritingFloat(false)
    }
  }
  
  // 读取线圈状态
  const readCoil = async () => {
    if (!plcStatus?.isConnected) {
      setPlcError('PLC未连接')
      return
    }
    
    setIsReadingCoil(true)
    setPlcError(null)
    
    try {
      const response = await fetch(`/api/plc/coil?address=${coilAddress}`)
      const result = await response.json()
      
      if (result.success) {
        setCoilValue(result.data.value)
      } else {
        setPlcError(result.error || '读取失败')
      }
    } catch (error) {
      console.error('读取线圈失败:', error)
      setPlcError('读取失败，请查看控制台')
    } finally {
      setIsReadingCoil(false)
    }
  }
  
  // 写入线圈状态
  const writeCoil = async (value: boolean) => {
    if (!plcStatus?.isConnected) {
      setPlcError('PLC未连接')
      return
    }
    
    setIsWritingCoil(true)
    setPlcError(null)
    
    try {
      const response = await fetch('/api/plc/coil', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          address: coilAddress,
          value: value
        })
      })
      
      const result = await response.json()
      
      if (result.success) {
        setCoilValue(value)
      } else {
        setPlcError(result.error || '写入失败')
      }
    } catch (error) {
      console.error('写入线圈失败:', error)
      setPlcError('写入失败，请查看控制台')
    } finally {
      setIsWritingCoil(false)
    }
  }

  // 更新PLC配置
  const updatePLCConfig = async () => {
    setIsUpdatingConfig(true)
    setPlcError(null)
    setConfigSuccess(null)
    
    // 验证IP地址格式
    const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    if (!ipRegex.test(plcConfig.host)) {
      setPlcError('请输入有效的IP地址格式，例如: 192.168.55.199');
      setIsUpdatingConfig(false);
      return;
    }
    
    try {
      const response = await fetch('/api/plc/config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(plcConfig)
      })
      
      const result = await response.json()
      
      if (result.success) {
        setConfigSuccess('PLC配置已成功更新')
        // 刷新PLC状态
        fetchPLCStatus()
      } else {
        setPlcError(result.error || '更新配置失败')
        console.error('更新PLC配置失败:', result.error)
      }
    } catch (error: any) {
      console.error('更新PLC配置失败:', error)
      setPlcError(`更新配置失败: ${error.message || '未知错误'}`)
    } finally {
      setIsUpdatingConfig(false)
    }
  }

  // 重置PLC配置为当前状态
  const resetConfig = () => {
    if (plcStatus) {
      setPlcConfig({
        host: plcStatus.config.host,
        port: plcStatus.config.port,
        unitId: plcStatus.config.unitId,
        timeout: plcStatus.config.timeout,
        reconnectInterval: plcStatus.config.reconnectInterval,
        maxReconnectAttempts: plcStatus.config.maxReconnectAttempts
      })
    }
    setPlcError(null)
    setConfigSuccess(null)
  }

  // 组件加载时初始化配置
  useEffect(() => {
    if (plcStatus?.config) {
      setPlcConfig({
        host: plcStatus.config.host,
        port: plcStatus.config.port,
        unitId: plcStatus.config.unitId,
        timeout: plcStatus.config.timeout,
        reconnectInterval: plcStatus.config.reconnectInterval,
        maxReconnectAttempts: plcStatus.config.maxReconnectAttempts
      })
    }
  }, [plcStatus])

  // 组件加载时获取数据
  useEffect(() => {
    fetchPLCStatus()
    fetchPLCLogs()
    
    // 定时刷新状态
    const interval = setInterval(() => {
      fetchPLCStatus()
      fetchPLCLogs()
    }, 5000)
    
    return () => clearInterval(interval)
  }, [])

  // 检查是否需要显示配置提醒
  useEffect(() => {
    if (plcStatus && (!plcStatus.config.host || plcStatus.config.host === '')) {
      setShowConfigAlert(true)
      setActiveTab('config')  // 自动切换到配置标签页
    } else {
      setShowConfigAlert(false)
    }
  }, [plcStatus])

  const filteredLogs = plcLogs.filter(log => {
    if (logFilter === 'all') return true
    return log.level === logFilter
  })

  return (
    <MainLayout>
      <div className="space-y-6">
        {/* 提示配置PLC地址的警告 */}
        {showConfigAlert && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-md p-4 text-yellow-800">
            <div className="flex">
              <AlertTriangle className="h-5 w-5 text-yellow-400 mr-3" />
              <div>
                <h3 className="text-sm font-medium">请配置PLC连接参数</h3>
                <p className="mt-2 text-sm">
                  您需要在PLC配置标签页中设置有效的PLC IP地址才能使用PLC功能。
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 焊笼机设备板块 */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <div className="flex items-center">
                <Building className="h-5 w-5 mr-2 text-gray-700" />
                <span className="text-gray-900 font-semibold">焊笼机设备 - {weldingMachineData.name}</span>
              </div>
              <div className="flex items-center space-x-2">
                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${
                  plcStatus?.isConnected 
                    ? 'text-green-600 bg-green-50 border-green-200'
                    : plcStatus?.isConnecting
                    ? 'text-yellow-600 bg-yellow-50 border-yellow-200'
                    : 'text-red-600 bg-red-50 border-red-200'
                }`}>
                  {plcStatus?.isConnected ? '已连接' : plcStatus?.isConnecting ? '连接中' : '未连接'}
                </span>
                <div className={`p-2 rounded-full ${plcStatus?.isConnected ? 'bg-green-100' : 'bg-red-100'}`}>
                  {plcStatus?.isConnected ? (
                    <CheckCircle className="h-4 w-4 text-green-600" />
                  ) : (
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                  )}
                </div>
              </div>
            </CardTitle>
            <CardDescription className="text-gray-700 font-medium">
              实时监控焊笼机运行状态和系统日志
            </CardDescription>
          </CardHeader>
          <CardContent>
            {/* 标签页切换 */}
            <div className="border-b border-gray-200 mb-6">
              <nav className="-mb-px flex space-x-8">
                <button
                  type="button"
                  onClick={() => setActiveTab('logs')}
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    activeTab === 'logs'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <FileText className="h-4 w-4 inline mr-2" />
                  上位机日志
                </button>
                <button
                  type="button"
                  onClick={() => setActiveTab('database')}
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    activeTab === 'database'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <Database className="h-4 w-4 inline mr-2" />
                  数据库记录
                </button>
                <button
                  type="button"
                  onClick={() => setActiveTab('plcio')}
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    activeTab === 'plcio'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <Settings className="h-4 w-4 inline mr-2" />
                  PLC读写
                </button>
                <button
                  type="button"
                  onClick={() => setActiveTab('config')}
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    activeTab === 'config'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <Server className="h-4 w-4 inline mr-2" />
                  PLC配置
                </button>
              </nav>
            </div>

            {/* 上位机日志内容 */}
            {activeTab === 'logs' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-4">
                    <h3 className="text-lg font-medium text-gray-900">PLC通信日志</h3>
                    {plcStatus && (
                      <div className="text-sm text-gray-600">
                        连接状态: {plcStatus.config.host}:{plcStatus.config.port}
                        {plcStatus.reconnectAttempts > 0 && (
                          <span className="ml-2 text-yellow-600">
                            (重连: {plcStatus.reconnectAttempts}/{plcStatus.maxReconnectAttempts})
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  <div className="flex space-x-2">
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                      <Input 
                        placeholder="搜索日志..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="pl-10 w-64"
                      />
                    </div>
                    <select
                      value={logFilter}
                      onChange={(e) => setLogFilter(e.target.value)}
                      className="h-10 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="all">所有级别</option>
                      <option value="INFO">信息</option>
                      <option value="WARNING">警告</option>
                      <option value="ERROR">错误</option>
                    </select>
                    {plcStatus?.isConnected ? (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        onClick={disconnectPLC}
                        disabled={isLoading}
                      >
                        <Pause className="h-4 w-4 mr-2" />
                        断开连接
                      </Button>
                    ) : (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        onClick={connectPLC}
                        disabled={isLoading}
                      >
                        <Play className="h-4 w-4 mr-2" />
                        连接PLC
                      </Button>
                    )}
                    <Button 
                      variant="outline" 
                      size="sm" 
                      onClick={refreshData}
                      disabled={isLoading}
                    >
                      <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                      刷新
                    </Button>
                  </div>
                </div>
                
                <div className="space-y-3">
                  {filteredLogs.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      暂无日志记录
                    </div>
                  ) : (
                    filteredLogs.map((log) => (
                      <div key={log.id} className="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center space-x-3 mb-2">
                              <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getLogLevelColor(log.level)}`}>
                                {log.level}
                              </span>
                              <span className="text-sm text-gray-500">{log.timestamp}</span>
                              <span className="text-sm text-gray-600">来源: {log.source}</span>
                            </div>
                            <h4 className="font-medium text-gray-900 mb-1">{log.message}</h4>
                            {log.details && (
                              <p className="text-sm text-gray-600">{log.details}</p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* 数据库记录内容 */}
            {activeTab === 'database' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-medium text-gray-900">数据库记录</h3>
                  <div className="flex space-x-2">
                    <Input 
                      placeholder="搜索记录..." 
                      className="w-64"
                    />
                    <Button variant="outline" size="sm">
                      <Upload className="h-4 w-4 mr-2" />
                      备份
                    </Button>
                  </div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-3 px-4 font-medium text-gray-900">时间</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-900">操作</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-900">表名</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-900">记录ID</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-900">描述</th>
                      </tr>
                    </thead>
                    <tbody>
                      {databaseRecords.map((record) => (
                        <tr key={record.id} className="border-b border-gray-100 hover:bg-gray-50">
                          <td className="py-3 px-4 text-sm text-gray-600">{record.timestamp}</td>
                          <td className="py-3 px-4">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getOperationColor(record.operation)}`}>
                              {record.operation}
                            </span>
                          </td>
                          <td className="py-3 px-4 text-sm text-gray-600">{record.table}</td>
                          <td className="py-3 px-4 text-sm text-gray-600">{record.record_id}</td>
                          <td className="py-3 px-4 text-sm text-gray-600">{record.description}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            
            {/* PLC读写内容 */}
            {activeTab === 'plcio' && (
              <div className="space-y-6">
                {/* PLC连接状态和操作按钮 */}
                <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-4">
                    <h3 className="text-lg font-medium text-gray-900">PLC读写控制</h3>
                    {plcStatus && (
                      <div className="text-sm text-gray-600">
                        连接状态: {plcStatus.config.host}:{plcStatus.config.port}
                      </div>
                    )}
                  </div>
                  <div className="flex space-x-2">
                    {plcStatus?.isConnected ? (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        onClick={disconnectPLC}
                        disabled={isLoading}
                      >
                        <Pause className="h-4 w-4 mr-2" />
                        断开连接
                      </Button>
                    ) : (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        onClick={connectPLC}
                        disabled={isLoading}
                      >
                        <Play className="h-4 w-4 mr-2" />
                        连接PLC
                      </Button>
                    )}
                  </div>
                </div>
                
                {/* 错误提示 */}
                {plcError && (
                  <div className="bg-red-50 border border-red-200 rounded-md p-4 text-red-600">
                    <AlertTriangle className="h-4 w-4 inline mr-2" />
                    {plcError}
                  </div>
                )}
                
                {/* 32位浮点寄存器读写 */}
                <div className="bg-white border border-gray-200 rounded-lg p-5 shadow-sm">
                  <h4 className="text-base font-medium text-gray-900 mb-4 flex items-center">
                    <Gauge className="h-5 w-5 mr-2 text-blue-600" />
                    32位浮点寄存器读写
                  </h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">寄存器地址</label>
                        <div className="flex space-x-2">
                          <Input 
                            type="number" 
                            value={floatRegisterAddress}
                            onChange={(e) => setFloatRegisterAddress(parseInt(e.target.value) || 0)}
                            className="w-32"
                          />
                          <Button 
                            variant="outline" 
                            onClick={readFloatRegister}
                            disabled={!plcStatus?.isConnected || isReadingFloat}
                          >
                            {isReadingFloat ? <RefreshCw className="h-4 w-4 mr-2 animate-spin" /> : <RefreshCw className="h-4 w-4 mr-2" />}
                            读取
                          </Button>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">当前值</label>
                        <div className="bg-gray-50 border border-gray-200 rounded-md p-3">
                          {floatRegisterValue !== null ? (
                            <span className="text-lg font-medium">{floatRegisterValue}</span>
                          ) : (
                            <span className="text-gray-500">尚未读取</span>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">写入值</label>
                        <div className="flex space-x-2">
                          <Input 
                            type="text" 
                            value={floatInputValue}
                            onChange={(e) => setFloatInputValue(e.target.value)}
                            placeholder="输入浮点数"
                          />
                          <Button 
                            variant="outline" 
                            onClick={writeFloatRegister}
                            disabled={!plcStatus?.isConnected || isWritingFloat || !floatInputValue}
                          >
                            {isWritingFloat ? <RefreshCw className="h-4 w-4 mr-2 animate-spin" /> : <Upload className="h-4 w-4 mr-2" />}
                            写入
                          </Button>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">
                          例如: 3.14, -2.5, 0.01
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* 线圈M读写 */}
                <div className="bg-white border border-gray-200 rounded-lg p-5 shadow-sm">
                  <h4 className="text-base font-medium text-gray-900 mb-4 flex items-center">
                    <ToggleLeft className="h-5 w-5 mr-2 text-blue-600" />
                    线圈M读写
                  </h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">线圈地址(M)</label>
                        <div className="flex space-x-2">
                          <Input 
                            type="number" 
                            value={coilAddress}
                            onChange={(e) => setCoilAddress(parseInt(e.target.value) || 0)}
                            className="w-32"
                          />
                          <Button 
                            variant="outline" 
                            onClick={readCoil}
                            disabled={!plcStatus?.isConnected || isReadingCoil}
                          >
                            {isReadingCoil ? <RefreshCw className="h-4 w-4 mr-2 animate-spin" /> : <RefreshCw className="h-4 w-4 mr-2" />}
                            读取
                          </Button>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">当前状态</label>
                        <div className="bg-gray-50 border border-gray-200 rounded-md p-3">
                          {coilValue !== null ? (
                            <div className="flex items-center">
                              <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full mr-2 ${
                                coilValue ? 'bg-green-100' : 'bg-red-100'
                              }`}>
                                {coilValue ? (
                                  <CheckCircle className="h-4 w-4 text-green-600" />
                                ) : (
                                  <AlertTriangle className="h-4 w-4 text-red-600" />
                                )}
                              </span>
                              <span className="text-lg font-medium">{coilValue ? 'ON' : 'OFF'}</span>
                            </div>
                          ) : (
                            <span className="text-gray-500">尚未读取</span>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    <div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-3">控制</label>
                        <div className="flex space-x-4">
                          <Button 
                            variant="outline" 
                            className={`flex-1 ${coilValue ? 'border-green-500 text-green-600' : ''}`}
                            onClick={() => writeCoil(true)}
                            disabled={!plcStatus?.isConnected || isWritingCoil}
                          >
                            <ToggleRight className="h-4 w-4 mr-2" />
                            打开
                          </Button>
                          <Button 
                            variant="outline"
                            className={`flex-1 ${coilValue === false ? 'border-red-500 text-red-600' : ''}`}
                            onClick={() => writeCoil(false)}
                            disabled={!plcStatus?.isConnected || isWritingCoil}
                          >
                            <ToggleLeft className="h-4 w-4 mr-2" />
                            关闭
                          </Button>
                        </div>
                        {isWritingCoil && (
                          <p className="text-xs text-center text-gray-500 mt-2">
                            <RefreshCw className="h-3 w-3 inline mr-1 animate-spin" />
                            更新中...
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* PLC配置内容 */}
            {activeTab === 'config' && (
              <div className="space-y-6">
                <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-4">
                    <h3 className="text-lg font-medium text-gray-900">PLC连接配置</h3>
                    {plcStatus && (
                      <div className="text-sm text-gray-600">
                        当前连接状态: {plcStatus.isConnected ? '已连接' : '未连接'}
                      </div>
                    )}
                  </div>
                  <div className="flex space-x-2">
                    <Button 
                      variant="outline" 
                      size="sm" 
                      onClick={resetConfig}
                    >
                      <RefreshCw className="h-4 w-4 mr-2" />
                      重置
                    </Button>
                    <Button 
                      variant="default" 
                      size="sm" 
                      onClick={updatePLCConfig}
                      disabled={isUpdatingConfig}
                    >
                      <Save className="h-4 w-4 mr-2" />
                      {isUpdatingConfig ? '更新中...' : '保存配置'}
                    </Button>
                  </div>
                </div>
                
                {/* 错误或成功提示 */}
                {plcError && (
                  <div className="bg-red-50 border border-red-200 rounded-md p-4 text-red-600">
                    <AlertTriangle className="h-4 w-4 inline mr-2" />
                    {plcError}
                  </div>
                )}
                
                {configSuccess && (
                  <div className="bg-green-50 border border-green-200 rounded-md p-4 text-green-600">
                    <CheckCircle className="h-4 w-4 inline mr-2" />
                    {configSuccess}
                  </div>
                )}
                
                <div className="bg-white border border-gray-200 rounded-lg p-5 shadow-sm">
                  <h4 className="text-base font-medium text-gray-900 mb-4 flex items-center">
                    <Server className="h-5 w-5 mr-2 text-blue-600" />
                    PLC连接参数
                  </h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">IP地址</label>
                        <Input 
                          type="text" 
                          value={plcConfig.host}
                          onChange={(e) => setPlcConfig({...plcConfig, host: e.target.value})}
                          placeholder="例如: 192.168.55.199"
                        />
                      </div>
                      
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">端口</label>
                        <Input 
                          type="number" 
                          value={plcConfig.port}
                          onChange={(e) => setPlcConfig({...plcConfig, port: parseInt(e.target.value) || 502})}
                          placeholder="默认: 502"
                        />
                      </div>
                      
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">单元ID</label>
                        <Input 
                          type="number" 
                          value={plcConfig.unitId}
                          onChange={(e) => setPlcConfig({...plcConfig, unitId: parseInt(e.target.value) || 1})}
                          placeholder="默认: 1"
                        />
                      </div>
                    </div>
                    
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">连接超时(毫秒)</label>
                        <Input 
                          type="number" 
                          value={plcConfig.timeout}
                          onChange={(e) => setPlcConfig({...plcConfig, timeout: parseInt(e.target.value) || 5000})}
                          placeholder="默认: 5000"
                        />
                      </div>
                      
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">重连间隔(毫秒)</label>
                        <Input 
                          type="number" 
                          value={plcConfig.reconnectInterval}
                          onChange={(e) => setPlcConfig({...plcConfig, reconnectInterval: parseInt(e.target.value) || 3000})}
                          placeholder="默认: 3000"
                        />
                      </div>
                      
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">最大重连次数</label>
                        <Input 
                          type="number" 
                          value={plcConfig.maxReconnectAttempts}
                          onChange={(e) => setPlcConfig({...plcConfig, maxReconnectAttempts: parseInt(e.target.value) || 3})}
                          placeholder="默认: 3"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-600">
                  <p><strong>提示:</strong> 修改配置后，如果当前PLC已连接，您需要断开连接并重新连接才能应用新配置。</p>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </MainLayout>
  )
} 